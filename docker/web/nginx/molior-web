# Molior-web server configuration
#
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /usr/share/molior-web;

        # Add index.php to the list if you are using PHP

        server_name _;

        location / {
            try_files $uri $uri/ /index.html;
        }

        location /api {
            proxy_set_header                Host            $host;
            proxy_set_header                X-Real-Ip       $remote_addr;
            proxy_pass                      http://molior:9999;
        }

        location /api/websocket {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header                Host            $host;
            proxy_set_header                X-Real-Ip       $remote_addr;
            proxy_pass                      http://molior:9999/api/websocket;
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
        }

        location /internal/buildupload {
            proxy_set_header                Host            $host;
            proxy_set_header                X-Real-Ip       $remote_addr;
            proxy_pass                      http://molior:9999/internal/buildupload;
            client_max_body_size 4G;
        }

        location /internal/buildlog {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header                Host            $host;
            proxy_set_header                X-Real-Ip       $remote_addr;
            proxy_pass                      http://molior:9999/internal/buildlog;
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
        }

        location /internal/registry {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header                Host            $host;
            proxy_set_header                X-Real-Ip       $remote_addr;
            proxy_pass                      http://molior:9999/internal/registry;
            proxy_connect_timeout 365d;
            proxy_send_timeout 365d;
            proxy_read_timeout 365d;
        }

        location /schroots {
            charset UTF-8;
            alias /var/lib/schroot/chroots;
            autoindex on;
        }

        location /debootstrap {
            charset UTF-8;
            alias /var/lib/molior/debootstrap;
            autoindex on;
        }

        location /buildout {
            charset UTF-8;
            alias /var/lib/molior/buildout;
            autoindex on;
            location ~* \.log$ {
                add_header Content-Type text/plain;
            }
        }

        location /doc {
            charset UTF-8;
            gzip_static on;
            alias /usr/share/doc/molior/;
            add_header Content-Type text/plain;
        }

        location /userdoc {
            alias /usr/share/doc/molior/userdocs;
            autoindex on;
        }
}
