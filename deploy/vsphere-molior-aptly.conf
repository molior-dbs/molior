# vim: syntax=sh

DEPLOYMENT_TYPE=ova
ARCH=amd64
TARGET_HOSTNAME=molior
TARGET_BOOTTYPE=efi
INSTALL_PACKAGE=molior-vsphere
LINUX_CMDLINE="biosdevname=0 net.ifnames=0 systemd.show_status=0 loglevel=0 vt.global_cursor_default=0 rd.loglevel=0 rd.udev.log-priority=0 udev.log-priority=0 init=/lib/systemd/systemd"
MINIMIZE=1

VM_SIZE=163840 # 160GB
VM_RAM=8192    #   8GB
VM_CPUS=4

VM_NAME="Molior Server"
VM_DESCRIPTION="molior - Debian Build System"

APT_INSTALL_EXTRA="open-vm-tools systemd-sysv python3-pip libcurl4-openssl-dev libssl-dev tmux tig tree tox python3-dev"

SFDISK="unit: sectors
label: gpt
efi:  type=C12A7328-F81F-11D2-BA4B-00A0C93EC93B, size=96M, start=2048
swap: type=0657FD6D-A4AB-43C4-84E5-0933C84B4F4F, size=512M,
root: type=0FC63DAF-8483-4772-8E79-3D69D8477DE4"

PART1_FS=vfat
PART1_MNT=/boot/efi
PART2_FS=swap
PART3_FS=ext4
PART3_MNT=/

postinst_deployment()
{
  # Use annotated APT sources
  echo "$APT_SOURCES_ORIG" >$target/etc/apt/sources.list

  log "configuring aptly"
  chroot $target create-aptly-passwd molior molior-dev
  sed -i 's/8000/8080/' $target/etc/nginx/sites-enabled/aptly
  sed -i 's/8080/3143/' $target/etc/nginx/sites-enabled/aptlyapi
  sed -i 's/https/3142/' $target/etc/shorewall/rules.d/molior-web.conf

  log "configuring user"
  sed -i "s/\\\\\$ '$/\$(__git_ps1)\\\\\$ '/" $target/home/admin/.bashrc
  cat >> $target/home/admin/.bashrc <<'EOF'

  echo "admin        ALL=(ALL)       NOPASSWD: ALL" > /etc/sudoers.d/03_admin

  # Get the current IP address of the machine
  current_ip=$(hostname -I | awk '{print $1}')

  # Replace '127.0.0.1' with the actual IP address only in the apt_url line
  sed -i "s/apt_url: 'http:\/\/127.0.0.1:8080'/apt_url: 'http:\/\/${current_ip}:8080'/g" /etc/molior/molior.yml


  # Setup Instructions
  cat >> $SYSHOME/.bashrc <<EOF

echo
echo -e "\e[36m\e[1mMolior vSphere VM\e[0m"
echo
echo " * You are logged in as user $SYSUSER"
echo " * See README.txt for installation and configuration instructions"
echo
EOF

  cat > $target/home/admin/README.md <<'EOF'

Molior Server
==============

This VM runs the following services:
- molior-server
- molior-web      (http://localhost, http://localhost:8888 on the host system)
- aptly      (http://localhost:3142, http://localhost:8889 on the host system)
- ssh         (user/pass: admin/molior-dev, localhost:8222 on the host system)

Setup and Configuration
------------------------

1) Change password
~~~~~~~~~~~~~~~~~~~

```
passwd
```

1) Generate keys
~~~~~~~~~~~~~~~~~

Run the following commands to create the molior and aptly GPG/SSH keys:

```
sudo create-molior-keys "Molior Debsign" debsign@molior.info
sudo create-aptly-keys "Molior Reposign" reposign@molior.info
sudo -u molior sh -c "gpg --armor --export debsign@molior.info | gpg --import --no-default-keyring --keyring=trustedkeys.gpg"
```
EOF

  postinst_deployment_ova
}
